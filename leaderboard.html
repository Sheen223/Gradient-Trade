<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GradientTrade â€” Leaderboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="leaderboard.css">
</head>
<body>

<aside class="sidebar">
  <div class="sidebar-logo">
    <svg width="28" height="28" viewBox="0 0 40 40" fill="none">
      <path d="M20 4 L36 14 L36 26 L20 36 L4 26 L4 14 Z" stroke="rgba(127,206,206,0.9)" stroke-width="2" fill="none"/>
      <path d="M20 4 L20 36 M4 14 L36 26 M4 26 L36 14" stroke="rgba(127,206,206,0.4)" stroke-width="1.5"/>
      <circle cx="20" cy="20" r="4" fill="rgba(127,206,206,0.9)"/>
    </svg>
    GradientTrade
  </div>
  <nav class="sidebar-nav">
    <a href="dashboard.html"   class="nav-item"><span class="nav-icon"></span> Dashboard</a>
    <a href="trade.html"       class="nav-item"><span class="nav-icon"></span> Trade</a>
    <a href="leaderboard.html" class="nav-item active"><span class="nav-icon"></span> Leaderboard</a>
    <a href="portfolio.html"   class="nav-item"><span class="nav-icon"></span> Portfolio</a>
    <a href="settings.html"    class="nav-item"><span class="nav-icon"></span> Settings</a>
  </nav>
  <div class="sidebar-user">
    <div class="user-info">
      <div class="user-avatar" id="user-avatar">??</div>
      <div>
        <div class="user-name" id="user-name">Loading...</div>
        <div class="user-balance">â€”</div>
      </div>
    </div>
  </div>
</aside>

<main class="main">
  <div class="topbar">
    <h2>Leaderboard</h2>
    <div class="period-filter">
      <button class="pf-btn">Today</button>
      <button class="pf-btn">7 Days</button>
      <button class="pf-btn active">All Time</button>
    </div>
  </div>

  <div class="podium" id="podium">
    <!-- rendered by JS -->
    <div style="padding:40px;opacity:0.5;text-align:center;width:100%;">Loading leaderboard...</div>
  </div>

  <div class="your-rank" id="your-rank-banner">
    <div class="your-rank-left">
      <div class="rank-badge" id="my-rank-badge">â€”</div>
      <div class="your-rank-info">
        <div class="label">Your Ranking</div>
        <div class="val" id="your-rank-val">â€”</div>
      </div>
    </div>
    <div class="your-rank-stats">
      <div class="rank-stat"><div class="label">Portfolio</div><div class="val" id="my-portfolio">â€”</div></div>
      <div class="rank-stat"><div class="label">Return</div><div class="val" id="my-return">â€”</div></div>
      <div class="rank-stat"><div class="label">Trades</div><div class="val" id="my-trades">â€”</div></div>
    </div>
  </div>

  <div class="lb-table">
    <div class="table-head">
      <span>Rank</span><span>Trader</span><span>Portfolio Value</span><span>Return</span><span>Win Rate</span><span>Trades</span>
    </div>
    <div id="lb-body">
      <div style="padding:20px;opacity:0.5;text-align:center;">Loading...</div>
    </div>
  </div>
</main>

<script type="module">
  import { requireAuth, loadSidebar, getLeaderboard } from './firebase.js';

  requireAuth(async (user, userData) => {
    loadSidebar(user, userData);

    let leaders;
    try {
      leaders = await getLeaderboard();
    } catch(e) {
      if (e.message === 'PERMISSION_DENIED') {
        document.getElementById('podium').innerHTML = `
          <div style="padding:40px;text-align:center;width:100%;">
            <div style="font-size:1.5rem;margin-bottom:12px;">ðŸ”’</div>
            <div style="font-weight:700;color:var(--text-dark);margin-bottom:8px;">Firestore Rules Need Updating</div>
            <div style="font-size:0.85rem;color:var(--text-muted);max-width:420px;margin:0 auto;line-height:1.6;">
              The leaderboard needs permission to read all users. In your Firebase Console, update your <strong>Firestore Security Rules</strong> to include:<br><br>
              <code style="background:rgba(0,0,0,0.08);padding:8px 12px;border-radius:8px;display:block;text-align:left;font-size:0.78rem;">
                match /users/{userId} {<br>
                &nbsp;&nbsp;allow read: if request.auth != null;<br>
                &nbsp;&nbsp;allow write: if request.auth.uid == userId;<br>
                }<br>
                match /trades/{tradeId} {<br>
                &nbsp;&nbsp;allow read: if request.auth != null;<br>
                &nbsp;&nbsp;allow write: if request.auth != null;<br>
                }
              </code>
            </div>
          </div>`;
        document.getElementById('lb-body').innerHTML = '';
        return;
      }
      leaders = [];
    }

    if (!leaders.length) {
      document.getElementById('podium').innerHTML = '<div style="padding:40px;opacity:0.5;text-align:center;width:100%;">No traders yet â€” be the first!</div>';
      return;
    }

    const displayName = userData.displayName || user?.displayName || 'Guest';
    const myEntry     = leaders.find(l => l.uid === user?.uid);
    const myRank      = myEntry ? myEntry.rank : 'â€”';

    const colorPool = [
      '#c8930a,#f7c44a', '#5BB8C4,#3A9AAA', '#9945ff,#14f195',
      '#e84142,#ff7b7b', '#f7931a,#ffb347', '#14f195,#0db774',
      '#627eea,#a8b8f8', '#3A9AAA,#163d30', '#5BB8C4,#163d30', '#f7931a,#e84142',
    ];

    function getColor(i, uid) { return uid === user?.uid ? '#3A9AAA,#163d30' : colorPool[i % colorPool.length]; }
    function getInits(name)   { return (name || 'U').split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2); }
    // Use totalPortfolioValue (cash + live coin holdings) for all display
    function fmtBal(entry)    { const v = entry.totalPortfolioValue ?? entry.balance ?? 0; return '$' + Number(v).toLocaleString('en-US', { maximumFractionDigits: 0 }); }
    function fmtRet(entry)    { const v = entry.totalPortfolioValue ?? entry.balance ?? 0; const r = ((v - 10000) / 10000) * 100; return (r >= 0 ? '+' : '') + r.toFixed(1) + '%'; }
    function isUp(entry)      { return (entry.totalPortfolioValue ?? entry.balance ?? 0) >= 10000; }

    // Your rank banner
    document.getElementById('my-rank-badge').textContent = '#' + myRank;
    document.getElementById('your-rank-val').textContent  = displayName + (myEntry ? ' Â· Top ' + Math.max(1, Math.round((myRank / leaders.length) * 100)) + '%' : '');
    document.getElementById('my-portfolio').textContent   = myEntry ? fmtBal(myEntry) : 'â€”';
    document.getElementById('my-return').textContent      = myEntry ? fmtRet(myEntry) : 'â€”';
    document.getElementById('my-return').className        = 'val ' + (myEntry && isUp(myEntry) ? 'up' : 'down');
    document.getElementById('my-trades').textContent      = myEntry?.totalTrades ?? 'â€”';

    // Podium
    function renderPodium(data) {
      if (data.length < 1) return;
      const first  = data[0];
      const second = data[1] || null;
      const third  = data[2] || null;
      document.getElementById('podium').innerHTML = `
        ${second ? `<div class="podium-card second">
          <div class="podium-rank">#2</div>
          <div class="podium-avatar" style="background:linear-gradient(135deg,${getColor(1, second.uid)});">${getInits(second.displayName)}</div>
          <div class="podium-name">${second.displayName}</div>
          <div class="podium-value">${fmtBal(second)}</div>
          <div class="podium-return">${fmtRet(second)}</div>
          <div class="podium-trades">${second.totalTrades ?? 0} trades</div>
        </div>` : ''}
        <div class="podium-card first">
          <div class="podium-crown">ðŸ‘‘</div>
          <div class="podium-rank">#1</div>
          <div class="podium-avatar" style="background:linear-gradient(135deg,${getColor(0, first.uid)});">${getInits(first.displayName)}</div>
          <div class="podium-name">${first.displayName}</div>
          <div class="podium-value">${fmtBal(first)}</div>
          <div class="podium-return">${fmtRet(first)}</div>
          <div class="podium-trades">${first.totalTrades ?? 0} trades</div>
        </div>
        ${third ? `<div class="podium-card third">
          <div class="podium-rank">#3</div>
          <div class="podium-avatar" style="background:linear-gradient(135deg,${getColor(2, third.uid)});">${getInits(third.displayName)}</div>
          <div class="podium-name">${third.displayName}</div>
          <div class="podium-value">${fmtBal(third)}</div>
          <div class="podium-return">${fmtRet(third)}</div>
          <div class="podium-trades">${third.totalTrades ?? 0} trades</div>
        </div>` : ''}`;
    }

    // Table
    function renderTable(data) {
      const rankColors = ['gold', 'silver', 'bronze'];
      const myInitials = getInits(displayName);
      document.getElementById('lb-body').innerHTML = data.map((r, i) => {
        const isYou = r.uid === user?.uid;
        const up    = isUp(r);
        const winRate = r.totalTrades > 0 ? Math.round(((r.wins ?? 0) / r.totalTrades) * 100) + '%' : 'â€”';
        return `<div class="table-row${isYou ? ' you' : ''}">
          <span class="rank-num${i < 3 ? ' ' + rankColors[i] : ''}">${i + 1}</span>
          <div class="row-user">
            <div class="row-avatar" style="background:linear-gradient(135deg,${getColor(i, r.uid)});">${isYou ? myInitials : getInits(r.displayName)}</div>
            <div>
              <div class="row-name">${isYou ? displayName : r.displayName}</div>
              ${isYou ? '<div class="row-you">You</div>' : ''}
            </div>
          </div>
          <span style="font-weight:700;">${fmtBal(r)}</span>
          <span class="${up ? 'up' : 'down'}">${fmtRet(r)}</span>
          <span>${winRate}</span>
          <span>${r.totalTrades ?? 0}</span>
        </div>`;
      }).join('');
    }

    renderPodium(leaders);
    renderTable(leaders);

    document.querySelectorAll('.pf-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.pf-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        // All filters show same all-time data for now
        renderPodium(leaders);
        renderTable(leaders);
      });
    });
  });
</script>
</body>
</html>